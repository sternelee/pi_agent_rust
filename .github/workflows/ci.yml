name: ci

on:
  pull_request:
  push:
    branches: [main]

jobs:
  rust:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    env:
      CI: "true"
      VCR_MODE: "playback"
      VCR_CASSETTE_DIR: "tests/fixtures/vcr"
      RUST_BACKTRACE: "1"
    defaults:
      run:
        working-directory: pi_agent_rust
        shell: bash
    steps:
      - name: Checkout pi_agent_rust
        uses: actions/checkout@v4
        with:
          path: pi_agent_rust

      - name: Checkout asupersync
        uses: actions/checkout@v4
        with:
          repository: Dicklesworthstone/asupersync
          path: asupersync
          fetch-depth: 1

      - name: Checkout rich_rust
        uses: actions/checkout@v4
        with:
          repository: Dicklesworthstone/rich_rust
          path: rich_rust
          fetch-depth: 1

      - name: Checkout charmed_rust
        uses: actions/checkout@v4
        with:
          repository: Dicklesworthstone/charmed_rust
          path: charmed_rust
          fetch-depth: 1

      - name: Checkout sqlmodel_rust
        uses: actions/checkout@v4
        with:
          repository: Dicklesworthstone/sqlmodel_rust
          path: sqlmodel_rust
          fetch-depth: 1

      - name: Install system deps (fd, rg) [linux]
        if: runner.os == 'Linux'
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y fd-find ripgrep
          sudo ln -sf "$(command -v fdfind)" /usr/local/bin/fd

      - name: Install system deps (fd, rg) [macos]
        if: runner.os == 'macOS'
        run: |
          set -euxo pipefail
          brew install fd ripgrep

      - name: Install system deps (fd, rg) [windows]
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install -y fd ripgrep

      - name: Install Rust toolchain (nightly)
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Install cargo-llvm-cov
        if: runner.os == 'Linux'
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: No-mock dependency guard
        run: |
          set -euxo pipefail
          if rg -n --fixed-strings -e mockall -e mockito -e wiremock Cargo.toml Cargo.lock; then
            echo "Mocking crates are forbidden in dependencies."
            exit 1
          fi

      - name: No-mock code guard
        run: |
          set -euxo pipefail

          # Allowlisted exceptions (audited):
          # - MockHttp{Server,Request,Response}: deterministic local TCP server test infra.
          allow_re='^(MockHttp(Server|Request|Response))$'

          matches="$(rg -n --column --no-heading --color never -o '\b(Mock|Fake|Stub)[A-Za-z0-9_]+\b' tests || true)"
          if [ -z "$matches" ]; then
            exit 0
          fi

          violations="$(echo "$matches" | awk -F: -v allow_re="$allow_re" '$4 !~ allow_re { print }')"
          if [ -n "$violations" ]; then
            echo "$violations"
            echo
            echo "No-mock policy violation: Mock*/Fake*/Stub* identifiers are forbidden in tests."
            echo "Use VCR fixtures or real deps instead. See docs/TEST_COVERAGE_MATRIX.md."
            exit 1
          fi

      - name: cargo fmt
        run: cargo fmt --check

      - name: cargo clippy
        run: cargo clippy --all-targets -- -D warnings

      - name: cargo test
        run: cargo test --all-targets

      - name: Coverage summary (llvm-cov)
        if: runner.os == 'Linux'
        run: |
          set -euxo pipefail
          start=$(date +%s)
          echo "env: CI=$CI VCR_MODE=$VCR_MODE VCR_CASSETTE_DIR=$VCR_CASSETTE_DIR"
          cargo llvm-cov --all-targets --workspace --summary-only | tee llvm-cov-summary.txt
          end=$(date +%s)
          echo "coverage_summary_duration_s=$((end-start))"

      - name: Coverage gate (lcov)
        if: runner.os == 'Linux'
        run: |
          set -euxo pipefail
          start=$(date +%s)
          # Baseline (2026-02-03): 31.07% line coverage (cargo llvm-cov --summary-only)
          cargo llvm-cov --all-targets --workspace --lcov --output-path lcov.info --fail-under-lines 30
          ls -lah lcov.info
          end=$(date +%s)
          echo "coverage_lcov_duration_s=$((end-start))"

      - name: Coverage report (html)
        if: runner.os == 'Linux'
        run: cargo llvm-cov --all-targets --workspace --html

      - name: Upload coverage artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            pi_agent_rust/llvm-cov-summary.txt
            pi_agent_rust/lcov.info
            pi_agent_rust/target/llvm-cov/html
